rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'admin@finditfast.com' ||
              exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
    }
    
    function isOwner(resource) {
      return isAuthenticated() && request.auth.uid == resource.data.ownerId;
    }
    
    function isStoreOwner() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/storeOwners/$(request.auth.uid));
    }
    
    function isResourceOwner(resource) {
      return isAuthenticated() && request.auth.uid == resource.id;
    }

    // Global admin access rule - allows admins to read/write all collections
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Public app configuration (read for everyone, write for admins)
    match /appConfig/{docId} {
      allow read: if docId == 'public' || isAdmin();
      allow write: if isAdmin();
    }

    // Stores collection
    match /stores/{storeId} {
      // Anyone can read store information
      allow read: if true;
      
      // TEMPORARY: Allow creation of the specific virtual store for debugging
      allow create: if storeId == 'virtual_BH0EzH7YqEMmWJbETerJ';
      
      // TEMPORARY: Allow updating the specific virtual store for fixing address
      allow update: if storeId == 'virtual_BH0EzH7YqEMmWJbETerJ';
      
      // Only authenticated store owners can create stores, or admins
      // Special case: allow creation for temporary store IDs (temp_*) by authenticated store owners
      allow create: if (isAuthenticated() && 
                       isStoreOwner() &&
                       request.auth.uid == resource.data.ownerId) || isAdmin() ||
                       (isAuthenticated() && isStoreOwner() && storeId.size() > 5 && storeId[0:5] == 'temp_');
      
      // Only the store owner can update their store, or admins
      // Special case: allow updates for temporary store IDs (temp_*) by authenticated store owners
      allow update: if isOwner(resource) || isAdmin() || 
                       (isAuthenticated() && isStoreOwner() && storeId.size() > 5 && storeId[0:5] == 'temp_');
      
      // Only the store owner can delete their store, or admins
      allow delete: if isOwner(resource) || isAdmin();
    }

    // Items collection
    match /items/{itemId} {
      // Anyone can read items
      allow read: if true;
      
      // Temporarily allow anyone to create items for debugging
      // TODO: Re-enable strict store owner checks once auth is working
      allow create: if true;
      
      // Original strict rules (commented out for debugging):
      // Only store owners can create items for their stores, or admins
      // allow create: if isAdmin() || (isAuthenticated() && 
      //                 isStoreOwner() &&
      //                 exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
      //                 get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid);
      
      // TEMPORARY: Allow anyone to update items for debugging (bypassing auth restrictions)
      allow update: if true;
      
      // Original strict rules (commented out for debugging):
      // Only the store owner can update items in their store, or admins
      // allow update: if isAdmin() || (isAuthenticated() && 
      //                 isStoreOwner() &&
      //                 exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
      //                 get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid);
      
      // TEMPORARY: Allow anyone to delete items for debugging
      allow delete: if true;
      
      // Original strict rules (commented out for debugging):
      // Only the store owner can delete items from their store, or admins
      // allow delete: if isAdmin() || (isAuthenticated() && 
      //                 isStoreOwner() &&
      //                 exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
      //                 get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid);
    }

    // Store owners collection
    match /storeOwners/{ownerId} {
      // Temporarily allow all authenticated users to read/write storeOwners for debugging
      allow read, write: if isAuthenticated();
      
      // Original rules (commented out for debugging):
      // Store owners can read their own data, admins can read all
      // allow read: if isResourceOwner(resource) || isAdmin();
      
      // Only authenticated users can create store owner profiles for themselves
      // allow create: if isAuthenticated() && 
      //                 request.auth.uid == ownerId;
      
      // Store owners can update their own data, admins can update any
      // allow update: if isResourceOwner(resource) || isAdmin();
      
      // Store owners can delete their own data, admins can delete any
      // allow delete: if isResourceOwner(resource) || isAdmin();
    }

    // Store plans collection
    match /storePlans/{planId} {
      // Anyone can read store plans (for floorplan viewing)
      allow read: if true;
      
      // TEMPORARY: Allow anyone to update store plans for fixing data
      allow write: if true;
      
      // Original rule (will restore after fix):
      // Only authenticated users can write (create/update/delete) store plans
      // allow write: if isAuthenticated();
      
      // Original rules (commented out for debugging):
      // Store owners can read their own plans and plans for their stores, admins can read all
      // allow read: if isAdmin() || (isAuthenticated() && 
      //               (resource.data.ownerId == request.auth.uid ||
      //                exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
      //                get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid));
      
      // Store owners can create plans for their stores, admins can create any
      // allow create: if isAdmin() || (isAuthenticated() && 
      //                 isStoreOwner() &&
      //                 request.auth.uid == request.resource.data.ownerId &&
      //                 (request.resource.data.storeId.matches('temp_.*') ||
      //                  (exists(/databases/$(database)/documents/stores/$(request.resource.data.storeId)) &&
      //                   get(/databases/$(database)/documents/stores/$(request.resource.data.storeId)).data.ownerId == request.auth.uid)));
      
      // Store owners can update their own plans, admins can update any
      // allow update: if isAdmin() || (isAuthenticated() && 
      //                 resource.data.ownerId == request.auth.uid);
      
      // Store owners can delete their own plans, admins can delete any
      // allow delete: if isAdmin() || (isAuthenticated() && 
      //                 resource.data.ownerId == request.auth.uid);
    }

    // Reports collection
    match /reports/{reportId} {
      // Anyone can read reports (for analytics/admin purposes)
      allow read: if true;
      
      // Anyone can create reports (users reporting issues)
      allow create: if true;
      
      // Authenticated users can update reports - simplified rule
      // Check if user owns a store that matches the report's storeId
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Check if store exists in stores collection with matching ownerId
        (exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid) ||
        // Check if store exists in storeRequests collection with matching ownerId
        (exists(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)).data.ownerId == request.auth.uid) ||
        // Check if store exists in storeRequests collection with matching requestedBy
        (exists(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)).data.requestedBy == request.auth.uid)
      );
      
      // Same logic for delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        // Check if store exists in stores collection with matching ownerId
        (exists(/databases/$(database)/documents/stores/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid) ||
        // Check if store exists in storeRequests collection with matching ownerId
        (exists(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)).data.ownerId == request.auth.uid) ||
        // Check if store exists in storeRequests collection with matching requestedBy
        (exists(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)) &&
         get(/databases/$(database)/documents/storeRequests/$(resource.data.storeId)).data.requestedBy == request.auth.uid)
      );
    }

    // Store requests collection
    match /storeRequests/{requestId} {
      // Public read access for all store requests (filtering for approved status done in app logic)
      // This allows both search functionality and individual item details to work
      allow read: if true;
      
      // Any authenticated user can create store requests with their own requestedBy
      allow create: if isAuthenticated() && 
                       request.resource.data.requestedBy == request.auth.uid;
      
      // Store owners can update their own requests, admins can update any
      allow update: if isAdmin() || (isAuthenticated() && 
                       resource.data.requestedBy == request.auth.uid);
      
      // Store owners can delete their own requests, admins can delete any
      allow delete: if isAdmin() || (isAuthenticated() && 
                       resource.data.requestedBy == request.auth.uid);
    }

    // Search logs collection (for analytics)
    match /searchLogs/{logId} {
      // Allow anyone to create search logs (anonymous analytics)
      allow create: if true;
      
      // Only admins can read search logs
      allow read: if isAdmin();
      
      // No updates or deletes allowed for search logs
    }

    // User activity logs collection (for analytics)
    match /userActivity/{activityId} {
      // Allow authenticated users to create activity logs
      allow create: if isAuthenticated();
      
      // Only admins can read user activity logs
      allow read: if isAdmin();
      
      // No updates or deletes allowed for activity logs
    }

    // Admins collection
    match /admins/{adminId} {
      // Admins can read their own data
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      
      // Allow admin creation (for setup)
      allow create: if isAuthenticated() && 
                       request.auth.uid == adminId &&
                       request.auth.token.email == resource.data.email;
      
      // Admins can update their own data
      allow update: if isAuthenticated() && request.auth.uid == adminId;
      
      // Admins can delete their own data
      allow delete: if isAuthenticated() && request.auth.uid == adminId;
    }

    // User Requests collection - for customer requests for new stores/items
    match /userRequests/{requestId} {
      // Anyone can create a request (both authenticated and anonymous users)
      allow create: if true;
      
      // Any authenticated user can read requests (so store owners can see them)
      allow read: if isAuthenticated();
      
      // Any authenticated user can update requests (to change status)
      allow update: if isAuthenticated();
      
      // Only admins can delete requests
      allow delete: if isAdmin();
    }
  }
}